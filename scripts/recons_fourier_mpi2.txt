 [nummps]                     = 1            ; No threads by default if MPI is used
 GLO [next_group_align]       = 'docfile'    ; Alignment parameter output file
 GLO [next_group_vol]         = 'volume'     ; Next group volumes
 GLO [aligned_images]         = 'particles_aligned' ; Aligned particles ready for BP

; ----------------- END BATCH HEADER ---------------------------------

 MD
   SET MP                     ; Use [nummps] available OMP processors
   [nummps]

; Get number of images
 FI H [maxim],[nx],[ny]             ; Find total number of images (not [numparts])
   [aligned_images]@;               ; Input file needed                 (input)
   MAXIM,NX,NY                      ; Max. image number, image size

 ; Calculate new, refined volume using centered projections and 
 ; angles from align doc. file.  Creates two additional volumes from 
 ; random half subsets of images for use in resolution calculation.

 ; (If you have large images which give problems allocating memory in 'BP 32F', 
 ;     substitute operation 'BP 3F'.  Use that operation three times (with 3 
 ;     appropriate selection files for the images to be included) to create 
 ;     the three output volumes one by one.)
 BP 32F                         ; Back Projection - 3D Fourier
   [aligned_images]@******      ; Current aligned images template     (input)
   1-[maxim]                    ; Particle selection doc file         (input)
   [next_group_align]           ; Alignment parameter doc file        (input)
   *                            ; No symmetries  
   [next_group_vol]             ; Reconstructed group vol - overall   (output)
   [next_group_vol]_sub1        ; Reconstructed group vol - subset 1  (output)
   [next_group_vol]_sub2        ; Reconstructed group vol - subset 2  (output)

 DE
   [aligned_images]

EN
